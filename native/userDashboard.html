<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Antrean Pengguna</title>
    
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Menggunakan font Inter yang diimpor dari Google Fonts */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align at the top */
            min-height: 100vh; /* Full viewport height */
            padding: 1.5rem; /* Responsive padding for the entire body */
        }

        /* Overrides/Enhancements for table borders to ensure consistency with Tailwind's border utilities */
        table.min-w-full th,
        table.min-w-full td {
            border-color: #e5e7eb; /* Tailwind's default border-gray-200 color */
            padding: 0.75rem 1rem; /* Tailwind's default px-4 py-2 converted to rem */
        }
        
        /* Ensure table head background is consistent */
        table.min-w-full thead tr {
            background-color: #f9fafb; /* Tailwind's default bg-gray-50 slightly adjusted */
        }

        /* Custom styles for the confirmation modal (if still needed, though user-facing modals should be minimal) */
        .modal {
            display: none !important; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal.active {
            display: flex !important;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 1.5rem;
            border: 1px solid #d1d5db;
            width: 95%;
            max-width: 500px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            text-align: center;
        }
        @media (min-width: 640px) {
            .modal-content button {
                width: auto;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl w-full">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 text-center">Daftar Antrean</h1>
        <p class="text-gray-600 mb-6 text-center text-sm sm:text-base">Lihat status antrean dan informasi penting lainnya.</p>

        <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table class="min-w-full bg-white border-collapse">
                <thead>
                    <tr class="bg-gray-100 text-gray-700 text-sm md:text-base">
                        <th class="px-4 py-3 text-left">Antrean</th>
                        <th class="px-4 py-3 text-left">Nama</th>
                        <th class="px-4 py-3 text-left">No WA</th>
                        <th class="px-4 py-3 text-left">Status</th>
                        <th class="px-4 py-3 text-left">Reg. Time</th>
                    </tr>
                </thead>
                <tbody id="queueData" class="divide-y divide-gray-200 text-sm">
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">Memuat daftar antrean...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Custom Confirmation Modal (simplified for user-facing) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p class="text-lg font-medium mb-4" id="modalMessage"></p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="modalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">OK</button>
                <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md hidden">Batal</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Socket.io client library for real-time communication -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Inisialisasi koneksi Socket.io ke backend Express.js
        const socket = io('http://localhost:3001');

        // Event listener untuk koneksi sukses
        socket.on('connect', () => {
            console.log('Terhubung ke Socket.io server.');
        });

        // Event listener untuk disconnect
        socket.on('disconnect', () => {
            console.log('Terputus dari Socket.io server.');
        });

        // Mendengarkan event 'data_updated' dari server untuk memicu pembaruan data
        socket.on('data_updated', () => {
            console.log('Menerima notifikasi data diperbarui dari server. Memuat ulang data antrean.');
            loadQueueData(); // Panggil fungsi untuk memuat ulang tabel antrean
        });


        // --- Modal Functionality (Simplified for user-facing, always 'OK' confirmation) ---
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        let onConfirmCallback = null;

        function showInfoModal(message, callback) {
            modalMessage.textContent = message || "Operasi berhasil.";
            onConfirmCallback = callback;
            modalCancelBtn.classList.add('hidden');
            modalConfirmBtn.textContent = 'OK';
            modalConfirmBtn.onclick = () => {
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
                hideInfoModal();
            };
            confirmationModal.classList.add('active');
        }

        function hideInfoModal() {
            confirmationModal.classList.remove('active');
            onConfirmCallback = null;
        }

        // --- Utility Function: Mask Phone Number ---
        const maskPhoneNumber = (phoneNumber) => {
            if (!phoneNumber || phoneNumber.length <= 4) {
                return phoneNumber;
            }
            const lastFourDigits = phoneNumber.slice(-4);
            const maskedPart = 'x'.repeat(phoneNumber.length - 4);
            return maskedPart + lastFourDigits;
        };

        /**
         * Mengformat timestamp ISO string menjadi tanggal dan waktu yang mudah dibaca.
         * @param {string} isoString - Timestamp dalam format ISO 8601.
         * @returns {string} Tanggal dan waktu yang diformat atau '-' jika tidak valid.
         */
        const formatDateTime = (isoString) => {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) {
                    return '-';
                }
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                return date.toLocaleString('id-ID', options);
            } catch (e) {
                console.error("Error formatting date:", e);
                return '-';
            }
        };

        /**
         * Mengambil dan menampilkan data antrean pengguna dari server.
         */
        const loadQueueData = async () => {
            try {
                const response = await axios.get(`http://localhost:3001/api/users`);
                let bucket = ``;
                let users = response.data;
                let antrianCounter = 0;

                if (users.length > 0) {
                    // Filter keluar user dengan status 'admin' agar tidak muncul di dashboard publik
                    const filteredUsers = users.filter(user => user.status !== 'admin');

                    const waitingUsers = filteredUsers.filter(user => user.status === 'waiting');
                    waitingUsers.sort((a, b) => a.id - b.id);

                    const otherUsers = filteredUsers.filter(user => user.status !== 'waiting' && user.status !== 'pending' && user.status !== 'rejected').sort((a, b) => a.id - b.id);
                    const sortedUsers = [...waitingUsers, ...otherUsers];

                    for (let i = 0; i < sortedUsers.length; i++) {
                        const user = sortedUsers[i];
                        let antrianDisplay = '';
                        if (user.status === 'waiting') {
                            antrianCounter++;
                            antrianDisplay = antrianCounter;
                        }

                        const maskedNowa = maskPhoneNumber(user.nowa);
                        const regTimeDisplay = formatDateTime(user.regTime);


                        bucket +=
                        `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2">${antrianDisplay}</td>
                            <td class="px-4 py-2">${user.nama || '-'}</td>
                            <td class="px-4 py-2">${maskedNowa || '-'}</td>
                            <td class="px-4 py-2 capitalize">${user.status || '-'}</td>
                            <td class="px-4 py-2">${regTimeDisplay}</td>
                        </tr>
                        `;
                    }
                    document.getElementById('queueData').innerHTML = bucket;
                } else {
                    bucket += `
                        <tr>
                            <td colspan="5" class="px-4 py-4 text-center text-gray-500">Saat ini tidak ada antrean.</td>
                        </tr>
                    `;
                    document.getElementById('queueData').innerHTML = bucket;
                }
            } catch (error) {
                let bucket = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-red-500">Gagal memuat daftar antrean: ${error.response?.data?.message || error.message}. Pastikan Express.js server berjalan pada http://localhost:3001.</td>
                    </tr>
                `;
                document.getElementById('queueData').innerHTML = bucket;
                console.error("Error fetching queue data:", error);
            }
        };

        // Panggil loadQueueData saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadQueueData);
    </script>
</body>
</html>
